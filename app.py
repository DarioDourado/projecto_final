"""
üåç Dashboard Multilingual - An√°lise Salarial
Sistema Modular com P√°ginas Espec√≠ficas - VERS√ÉO CORRIGIDA
"""

import streamlit as st
import pandas as pd
import numpy as np
import plotly.express as px
import plotly.graph_objects as go
from plotly.subplots import make_subplots
from pathlib import Path
import logging
import sys
import warnings
import json
from datetime import datetime

# Configura√ß√µes
warnings.filterwarnings('ignore')

# Adicionar src ao path
sys.path.append(str(Path(__file__).parent / "src"))

# Configurar logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s'
)

# Configurar p√°gina
st.set_page_config(
    page_title="Dashboard Multilingual - An√°lise Salarial",
    page_icon="üåç",
    layout="wide",
    initial_sidebar_state="expanded"
)

class SimpleAuth:
    """Sistema de autentica√ß√£o simplificado"""
    
    def __init__(self):
        self.users = {
            'admin': {'password': 'admin123', 'name': 'Administrador', 'role': 'admin'},
            'user': {'password': 'user123', 'name': 'Usu√°rio', 'role': 'user'},
            'demo': {'password': 'demo123', 'name': 'Demo', 'role': 'user'}
        }
    
    def authenticate(self, username, password):
        """Autenticar usu√°rio"""
        if username in self.users and self.users[username]['password'] == password:
            st.session_state.authenticated = True
            st.session_state.user_data = self.users[username]
            st.session_state.username = username
            return True
        return False
    
    def is_authenticated(self):
        """Verificar se usu√°rio est√° autenticado"""
        return st.session_state.get('authenticated', False)
    
    def get_user_data(self):
        """Obter dados do usu√°rio"""
        return st.session_state.get('user_data', {})
    
    def logout(self):
        """Fazer logout"""
        st.session_state.authenticated = False
        st.session_state.user_data = {}
        st.session_state.username = ''

class MultilingualDashboard:
    """Dashboard principal com p√°ginas espec√≠ficas"""
    
    def __init__(self):
        """Inicializar dashboard"""
        self.auth = SimpleAuth()
        
        # P√°ginas espec√≠ficas
        self.pages = {
            'overview': {
                'title': 'Vis√£o Geral',
                'icon': 'üìä',
                'roles': ['admin', 'user'],
                'func': self._show_overview_page
            },
            'exploratory': {
                'title': 'An√°lise Explorat√≥ria',
                'icon': 'üîç',
                'roles': ['admin', 'user'],
                'func': self._show_exploratory_page
            },
            'models': {
                'title': 'Modelos ML',
                'icon': 'ü§ñ',
                'roles': ['admin', 'user'],
                'func': self._show_models_page
            },
            'clustering': {
                'title': 'Clustering',
                'icon': 'üéØ',
                'roles': ['admin', 'user'],
                'func': self._show_clustering_page
            },
            'association_rules': {
                'title': 'Regras de Associa√ß√£o',
                'icon': 'üìã',
                'roles': ['admin', 'user'],
                'func': self._show_association_rules_page
            },
            'prediction': {
                'title': 'Predi√ß√£o',
                'icon': 'üîÆ',
                'roles': ['admin', 'user'],
                'func': self._show_prediction_page
            },
            'metrics': {
                'title': 'M√©tricas',
                'icon': 'üìà',
                'roles': ['admin', 'user'],
                'func': self._show_metrics_page
            },
            'reports': {
                'title': 'Relat√≥rios',
                'icon': 'üìÅ',
                'roles': ['admin', 'user'],
                'func': self._show_reports_page
            },
            'admin': {
                'title': 'Administra√ß√£o',
                'icon': '‚öôÔ∏è',
                'roles': ['admin'],
                'func': self._show_admin_page
            }
        }
        
        # Estado inicial
        if 'current_page' not in st.session_state:
            st.session_state.current_page = 'overview'
        
        # Cache de dados
        self.data_cache = None
    
    def run(self):
        """Executar dashboard"""
        # CSS personalizado
        self._apply_css()
        
        # Header
        st.markdown("""
        <div class="main-header">
            üåç Dashboard Multilingual - An√°lise Salarial
        </div>
        """, unsafe_allow_html=True)
        
        # Verificar autentica√ß√£o
        if not self.auth.is_authenticated():
            self._show_login_page()
            return
        
        # Carregar dados uma vez
        if self.data_cache is None:
            self.data_cache = self._load_data()
        
        # Layout principal
        self._show_sidebar()
        self._execute_current_page()
    
    def _apply_css(self):
        """Aplicar CSS personalizado"""
        st.markdown("""
        <style>
        .main-header {
            background: linear-gradient(90deg, #1f4e79, #2c6aa0);
            color: white;
            padding: 1rem;
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            border-radius: 10px;
            margin-bottom: 2rem;
        }
        
        .nav-button-active {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
            border: none !important;
            padding: 0.75rem 1rem !important;
            border-radius: 10px !important;
            width: 100% !important;
            text-align: left !important;
            margin-bottom: 0.5rem !important;
            font-weight: 600 !important;
        }
        
        .nav-button-inactive {
            background: #f8f9fa !important;
            color: #495057 !important;
            border: 1px solid #dee2e6 !important;
            padding: 0.75rem 1rem !important;
            border-radius: 10px !important;
            width: 100% !important;
            text-align: left !important;
            margin-bottom: 0.5rem !important;
        }
        
        .user-section {
            background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%);
            color: white;
            padding: 1rem;
            border-radius: 15px;
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 1rem;
        }
        </style>
        """, unsafe_allow_html=True)
    
    def _load_data(self):
        """Carregar dados"""
        try:
            # Tentar v√°rios caminhos
            data_paths = [
                "bkp/4-Carateristicas_salario.csv",
                "data/raw/4-Carateristicas_salario.csv",
                "4-Carateristicas_salario.csv"
            ]
            
            df = None
            source = None
            
            for path in data_paths:
                if Path(path).exists():
                    df = pd.read_csv(path)
                    source = path
                    break
            
            if df is not None:
                # Limpeza b√°sica
                df = df.replace('?', pd.NA)
                
                # Escanear arquivos de an√°lise
                files_status = self._scan_analysis_files()
                
                return {
                    'df': df,
                    'status': f'‚úÖ Dados carregados de {source} ({len(df):,} registros)',
                    'files_status': files_status,
                    'source': source
                }
            else:
                # Dados de exemplo
                return self._create_sample_data()
                
        except Exception as e:
            logging.error(f"Erro ao carregar dados: {e}")
            return self._create_sample_data()
    
    def _scan_analysis_files(self):
        """Escanear arquivos de an√°lise"""
        files_status = {
            'analysis': [],
            'models': [],
            'images': []
        }
        
        # Diret√≥rios para verificar
        analysis_dirs = ['output/analysis', 'output', '.']
        models_dirs = ['models', 'data/processed', 'output/models']
        images_dirs = ['output/images', 'imagens', 'images']
        
        # An√°lises
        for dir_path in analysis_dirs:
            path = Path(dir_path)
            if path.exists():
                files_status['analysis'].extend(list(path.glob('*.csv')))
                files_status['analysis'].extend(list(path.glob('*.json')))
        
        # Modelos
        for dir_path in models_dirs:
            path = Path(dir_path)
            if path.exists():
                files_status['models'].extend(list(path.glob('*.pkl')))
                files_status['models'].extend(list(path.glob('*.joblib')))
        
        # Imagens
        for dir_path in images_dirs:
            path = Path(dir_path)
            if path.exists():
                files_status['images'].extend(list(path.glob('*.png')))
                files_status['images'].extend(list(path.glob('*.jpg')))
        
        return files_status
    
    def _create_sample_data(self):
        """Criar dados de exemplo"""
        try:
            np.random.seed(42)
            n_samples = 1000
            
            data = {
                'age': np.random.randint(18, 70, n_samples),
                'workclass': np.random.choice(['Private', 'Self-emp-not-inc', 'Federal-gov'], n_samples),
                'education': np.random.choice(['Bachelors', 'HS-grad', 'Masters'], n_samples),
                'education-num': np.random.randint(1, 17, n_samples),
                'marital-status': np.random.choice(['Married-civ-spouse', 'Divorced', 'Never-married'], n_samples),
                'occupation': np.random.choice(['Tech-support', 'Sales', 'Exec-managerial'], n_samples),
                'relationship': np.random.choice(['Wife', 'Husband', 'Not-in-family'], n_samples),
                'race': np.random.choice(['White', 'Black', 'Asian-Pac-Islander'], n_samples),
                'sex': np.random.choice(['Female', 'Male'], n_samples),
                'capital-gain': np.random.randint(0, 10000, n_samples),
                'capital-loss': np.random.randint(0, 5000, n_samples),
                'hours-per-week': np.random.randint(20, 80, n_samples),
                'native-country': np.random.choice(['United-States', 'Canada'], n_samples),
                'salary': np.random.choice(['<=50K', '>50K'], n_samples)
            }
            
            df = pd.DataFrame(data)
            
            return {
                'df': df,
                'status': '‚úÖ Dados de exemplo criados (1,000 registros)',
                'files_status': {'analysis': [], 'models': [], 'images': []},
                'source': 'sample_data'
            }
            
        except Exception as e:
            logging.error(f"Erro ao criar dados de exemplo: {e}")
            return {
                'df': None,
                'status': f'‚ùå Erro: {e}',
                'files_status': {'analysis': [], 'models': [], 'images': []},
                'source': None
            }
    
    def _show_login_page(self):
        """P√°gina de login"""
        col1, col2, col3 = st.columns([1, 2, 1])
        
        with col2:
            st.markdown("### üîê Login")
            
            with st.form("login_form", clear_on_submit=True):
                username = st.text_input("üë§ Nome de usu√°rio", placeholder="admin, user, demo")
                password = st.text_input("üîë Senha", type="password", placeholder="admin123, user123, demo123")
                
                if st.form_submit_button("üö™ Entrar", use_container_width=True):
                    if username and password:
                        if self.auth.authenticate(username, password):
                            st.success("‚úÖ Login realizado com sucesso!")
                            st.rerun()
                        else:
                            st.error("‚ùå Credenciais inv√°lidas!")
                    else:
                        st.warning("‚ö†Ô∏è Preencha todos os campos!")
            
            # Ajuda
            with st.expander("‚ÑπÔ∏è Credenciais de teste"):
                st.info("""
                **Credenciais dispon√≠veis:**
                - **admin** / **admin123** (Administrador)
                - **user** / **user123** (Usu√°rio)
                - **demo** / **demo123** (Demo)
                """)
    
    def _show_sidebar(self):
        """Mostrar sidebar"""
        with st.sidebar:
            # Informa√ß√µes do usu√°rio
            self._show_user_info()
            
            st.markdown("---")
            
            # Navega√ß√£o
            self._show_navigation()
            
            st.markdown("---")
            
            # Status dos dados
            self._show_data_status()
            
            st.markdown("---")
            
            # Controles
            if st.button("üîÑ Recarregar Dados", use_container_width=True):
                self.data_cache = None
                self.data_cache = self._load_data()
                st.success("‚úÖ Dados recarregados!")
                st.rerun()
    
    def _show_user_info(self):
        """Mostrar informa√ß√µes do usu√°rio"""
        user_data = self.auth.get_user_data()
        if user_data:
            st.markdown(f"""
            <div class="user-section">
                <h4>üë§ {user_data.get('name', 'N/A')}</h4>
                <p><strong>Papel:</strong> {user_data.get('role', 'user').title()}</p>
            </div>
            """, unsafe_allow_html=True)
            
            if st.button("üö™ Logout", use_container_width=True):
                self.auth.logout()
                st.rerun()
    
    def _show_navigation(self):
        """Mostrar navega√ß√£o"""
        st.markdown("### üß≠ Navega√ß√£o")
        
        user_data = self.auth.get_user_data()
        user_role = user_data.get('role', 'user')
        
        for page_key, page_info in self.pages.items():
            if user_role in page_info['roles']:
                button_text = f"{page_info['icon']} {page_info['title']}"
                is_current = st.session_state.current_page == page_key
                
                if is_current:
                    st.markdown(f"""
                    <div class="nav-button-active">
                        {button_text}
                    </div>
                    """, unsafe_allow_html=True)
                else:
                    if st.button(button_text, key=f"nav_{page_key}", use_container_width=True):
                        st.session_state.current_page = page_key
                        st.rerun()
    
    def _show_data_status(self):
        """Mostrar status dos dados"""
        st.markdown("### üìä Status dos Dados")
        
        if self.data_cache:
            status = self.data_cache.get('status', '‚ùå Erro')
            
            if "‚úÖ" in status:
                st.success(status)
            elif "‚ö†Ô∏è" in status:
                st.warning(status)
            else:
                st.error(status)
            
            df = self.data_cache.get('df')
            if df is not None:
                col1, col2 = st.columns(2)
                with col1:
                    st.metric("üìã Registros", f"{len(df):,}")
                with col2:
                    st.metric("üìä Colunas", len(df.columns))
    
    def _execute_current_page(self):
        """Executar p√°gina atual"""
        current_page = st.session_state.current_page
        
        if current_page in self.pages:
            try:
                self.pages[current_page]['func']()
            except Exception as e:
                st.error(f"‚ùå Erro ao carregar p√°gina: {e}")
                logging.error(f"Erro na p√°gina {current_page}: {e}")
        else:
            st.error(f"‚ùå P√°gina '{current_page}' n√£o encontrada")
    
    # =========================================================================
    # P√ÅGINAS ESPEC√çFICAS
    # =========================================================================
    
    def _show_overview_page(self):
        """P√°gina de vis√£o geral - ESPEC√çFICA"""
        st.header("üìä Vis√£o Geral do Dataset")
        
        df = self.data_cache.get('df') if self.data_cache else None
        
        if df is None:
            st.error("‚ùå Dados n√£o dispon√≠veis")
            return
        
        # M√©tricas principais
        col1, col2, col3, col4 = st.columns(4)
        
        with col1:
            st.markdown(f"""
            <div class="metric-card">
                <h3>üìã Registros</h3>
                <h2>{len(df):,}</h2>
            </div>
            """, unsafe_allow_html=True)
        
        with col2:
            st.markdown(f"""
            <div class="metric-card">
                <h3>üìä Colunas</h3>
                <h2>{len(df.columns)}</h2>
            </div>
            """, unsafe_allow_html=True)
        
        with col3:
            if 'salary' in df.columns:
                high_salary_rate = (df['salary'] == '>50K').mean()
                st.markdown(f"""
                <div class="metric-card">
                    <h3>üí∞ Sal√°rio Alto</h3>
                    <h2>{high_salary_rate:.1%}</h2>
                </div>
                """, unsafe_allow_html=True)
            else:
                st.markdown(f"""
                <div class="metric-card">
                    <h3>üí∞ Sal√°rio Alto</h3>
                    <h2>N/A</h2>
                </div>
                """, unsafe_allow_html=True)
        
        with col4:
            missing_rate = df.isnull().sum().sum() / (len(df) * len(df.columns))
            st.markdown(f"""
            <div class="metric-card">
                <h3>‚ùå Missing</h3>
                <h2>{missing_rate:.1%}</h2>
            </div>
            """, unsafe_allow_html=True)
        
        # Gr√°ficos de distribui√ß√£o
        st.subheader("üìà Distribui√ß√µes Principais")
        
        col1, col2 = st.columns(2)
        
        with col1:
            if 'salary' in df.columns:
                salary_counts = df['salary'].value_counts()
                fig = px.pie(
                    values=salary_counts.values,
                    names=salary_counts.index,
                    title="üí∞ Distribui√ß√£o de Sal√°rio"
                )
                st.plotly_chart(fig, use_container_width=True)
        
        with col2:
            if 'sex' in df.columns:
                sex_counts = df['sex'].value_counts()
                fig = px.bar(
                    x=sex_counts.index,
                    y=sex_counts.values,
                    title="üë• Distribui√ß√£o por Sexo"
                )
                st.plotly_chart(fig, use_container_width=True)
        
        # Amostra dos dados
        st.subheader("üìã Amostra dos Dados")
        st.dataframe(df.head(10), use_container_width=True)
        
        # Estat√≠sticas descritivas
        st.subheader("üìä Estat√≠sticas Descritivas")
        numeric_cols = df.select_dtypes(include=[np.number]).columns
        if len(numeric_cols) > 0:
            st.dataframe(df[numeric_cols].describe(), use_container_width=True)
    
    def _show_exploratory_page(self):
        """P√°gina de an√°lise explorat√≥ria - ESPEC√çFICA"""
        st.header("üîç An√°lise Explorat√≥ria Avan√ßada")
        
        df = self.data_cache.get('df') if self.data_cache else None
        
        if df is None:
            st.error("‚ùå Dados n√£o dispon√≠veis")
            return
        
        # Controles
        col1, col2, col3 = st.columns(3)
        
        with col1:
            numeric_cols = df.select_dtypes(include=[np.number]).columns.tolist()
            if numeric_cols:
                x_var = st.selectbox("üìä Vari√°vel X:", numeric_cols)
        
        with col2:
            y_var = st.selectbox("üìä Vari√°vel Y:", ["Nenhuma"] + numeric_cols)
        
        with col3:
            categorical_cols = df.select_dtypes(include=['object']).columns.tolist()
            if categorical_cols:
                color_var = st.selectbox("üé® Cor por:", ["Nenhuma"] + categorical_cols)
            else:
                color_var = "Nenhuma"
        
        # Gr√°ficos baseados na sele√ß√£o
        if 'x_var' in locals():
            if y_var != "Nenhuma":
                # Scatter plot
                fig = px.scatter(
                    df, x=x_var, y=y_var,
                    color=color_var if color_var != "Nenhuma" else None,
                    title=f"üìä {x_var} vs {y_var}"
                )
                st.plotly_chart(fig, use_container_width=True)
            else:
                # Histograma
                fig = px.histogram(
                    df, x=x_var,
                    color=color_var if color_var != "Nenhuma" else None,
                    title=f"üìä Distribui√ß√£o de {x_var}"
                )
                st.plotly_chart(fig, use_container_width=True)
        
        # An√°lises por categoria
        st.subheader("üéØ An√°lises por Categoria")
        
        if 'salary' in df.columns:
            col1, col2 = st.columns(2)
            
            with col1:
                if 'workclass' in df.columns:
                    workclass_salary = df.groupby('workclass')['salary'].apply(
                        lambda x: (x == '>50K').mean()
                    ).reset_index()
                    workclass_salary.columns = ['workclass', 'high_salary_rate']
                    
                    fig = px.bar(
                        workclass_salary, x='workclass', y='high_salary_rate',
                        title="üíº Taxa de Sal√°rio Alto por Classe de Trabalho"
                    )
                    fig.update_layout(xaxis_tickangle=45)
                    st.plotly_chart(fig, use_container_width=True)
            
            with col2:
                if 'education' in df.columns:
                    education_salary = df.groupby('education')['salary'].apply(
                        lambda x: (x == '>50K').mean()
                    ).reset_index()
                    education_salary.columns = ['education', 'high_salary_rate']
                    
                    fig = px.bar(
                        education_salary, x='education', y='high_salary_rate',
                        title="üéì Taxa de Sal√°rio Alto por Educa√ß√£o"
                    )
                    fig.update_layout(xaxis_tickangle=45)
                    st.plotly_chart(fig, use_container_width=True)
        
        # Correla√ß√µes
        st.subheader("üîó Matriz de Correla√ß√£o")
        numeric_cols = df.select_dtypes(include=[np.number]).columns
        if len(numeric_cols) > 1:
            corr_matrix = df[numeric_cols].corr()
            fig = px.imshow(
                corr_matrix,
                text_auto=True,
                title="üîó Matriz de Correla√ß√£o"
            )
            st.plotly_chart(fig, use_container_width=True)
    
    def _show_models_page(self):
        """P√°gina de modelos ML - ESPEC√çFICA"""
        st.header("ü§ñ Modelos de Machine Learning")
        
        df = self.data_cache.get('df') if self.data_cache else None
        files_status = self.data_cache.get('files_status', {}) if self.data_cache else {}
        
        if df is None:
            st.error("‚ùå Dados n√£o dispon√≠veis")
            return
        
        # Verificar modelos salvos
        model_files = files_status.get('models', [])
        
        if model_files:
            st.success(f"‚úÖ {len(model_files)} modelo(s) encontrado(s)")
            
            for model_file in model_files:
                with st.expander(f"üìÅ {model_file.name}"):
                    st.write(f"**Localiza√ß√£o:** {model_file}")
                    st.write(f"**Tamanho:** {model_file.stat().st_size / 1024:.1f} KB")
                    st.write(f"**Modificado:** {datetime.fromtimestamp(model_file.stat().st_mtime)}")
        else:
            st.warning("‚ö†Ô∏è Nenhum modelo treinado encontrado")
            st.info("üí° Execute o pipeline principal para treinar modelos: `python main.py`")
        
        # Prepara√ß√£o de dados (exemplo)
        st.subheader("üìä Prepara√ß√£o dos Dados para ML")
        
        if 'salary' in df.columns:
            # Target distribution
            target_dist = df['salary'].value_counts()
            fig = px.pie(
                values=target_dist.values,
                names=target_dist.index,
                title="üéØ Distribui√ß√£o da Vari√°vel Target (Salary)"
            )
            st.plotly_chart(fig, use_container_width=True)
        
        # Features num√©ricas
        numeric_features = df.select_dtypes(include=[np.number]).columns.tolist()
        if numeric_features:
            st.subheader("üìä Features Num√©ricas")
            selected_features = st.multiselect(
                "Selecione features para an√°lise:",
                numeric_features,
                default=numeric_features[:3] if len(numeric_features) >= 3 else numeric_features
            )
            
            if selected_features:
                st.dataframe(df[selected_features].describe(), use_container_width=True)
        
        # Informa√ß√µes sobre os algoritmos
        st.subheader("üß† Algoritmos Implementados")
        
        col1, col2 = st.columns(2)
        
        with col1:
            st.markdown("""
            **üå≥ Random Forest**
            - Ensemble de √°rvores de decis√£o
            - Reduz overfitting
            - Boa performance geral
            """)
        
        with col2:
            st.markdown("""
            **üìà Logistic Regression**
            - Modelo linear para classifica√ß√£o
            - Interpret√°vel
            - R√°pido para treinar
            """)
    
    def _show_clustering_page(self):
        """P√°gina de clustering - ESPEC√çFICA"""
        st.header("üéØ An√°lise de Clustering")
        
        df = self.data_cache.get('df') if self.data_cache else None
        files_status = self.data_cache.get('files_status', {}) if self.data_cache else {}
        
        if df is None:
            st.error("‚ùå Dados n√£o dispon√≠veis")
            return
        
        # Verificar resultados de clustering
        analysis_files = files_status.get('analysis', [])
        clustering_files = [f for f in analysis_files if 'dbscan' in str(f).lower() or 'cluster' in str(f).lower()]
        
        if clustering_files:
            st.success(f"‚úÖ {len(clustering_files)} arquivo(s) de clustering encontrado(s)")
            
            for file in clustering_files:
                with st.expander(f"üìÅ {file.name}"):
                    try:
                        if file.suffix == '.csv':
                            df_cluster = pd.read_csv(file)
                            st.dataframe(df_cluster.head(), use_container_width=True)
                            
                            # Visualizar clusters se poss√≠vel
                            if 'cluster' in df_cluster.columns:
                                cluster_counts = df_cluster['cluster'].value_counts()
                                fig = px.bar(
                                    x=cluster_counts.index,
                                    y=cluster_counts.values,
                                    title=f"üéØ Distribui√ß√£o de Clusters - {file.name}"
                                )
                                st.plotly_chart(fig, use_container_width=True)
                    except Exception as e:
                        st.error(f"Erro ao ler arquivo: {e}")
        else:
            st.warning("‚ö†Ô∏è Nenhum resultado de clustering encontrado")
            st.info("üí° Execute o pipeline principal para gerar clustering: `python main.py`")
        
        # Prepara√ß√£o para clustering
        st.subheader("üìä Prepara√ß√£o para Clustering")
        
        numeric_cols = df.select_dtypes(include=[np.number]).columns.tolist()
        if len(numeric_cols) >= 2:
            st.info(f"‚úÖ {len(numeric_cols)} vari√°veis num√©ricas dispon√≠veis para clustering")
            
            # Visualiza√ß√£o 2D das features
            col1, col2 = st.columns(2)
            
            with col1:
                x_feature = st.selectbox("Feature X:", numeric_cols, key="cluster_x")
            
            with col2:
                y_feature = st.selectbox("Feature Y:", numeric_cols, index=1 if len(numeric_cols) > 1 else 0, key="cluster_y")
            
            if x_feature and y_feature and x_feature != y_feature:
                # Scatter plot das features
                color_by = 'salary' if 'salary' in df.columns else None
                fig = px.scatter(
                    df, x=x_feature, y=y_feature,
                    color=color_by,
                    title=f"üìä {x_feature} vs {y_feature}"
                )
                st.plotly_chart(fig, use_container_width=True)
        else:
            st.warning("‚ö†Ô∏è Poucas vari√°veis num√©ricas para clustering eficaz")
        
        # Informa√ß√µes sobre algoritmos
        st.subheader("üß† Algoritmos de Clustering")
        
        col1, col2 = st.columns(2)
        
        with col1:
            st.markdown("""
            **üéØ DBSCAN**
            - Baseado em densidade
            - Detecta ru√≠do automaticamente
            - N√£o requer n√∫mero de clusters
            """)
        
        with col2:
            st.markdown("""
            **üéØ K-Means**
            - Baseado em centr√≥ides
            - R√°pido e eficiente
            - Requer n√∫mero de clusters
            """)
    
    def _show_association_rules_page(self):
        """P√°gina de regras de associa√ß√£o - ESPEC√çFICA"""
        st.header("üìã Regras de Associa√ß√£o")
        
        df = self.data_cache.get('df') if self.data_cache else None
        files_status = self.data_cache.get('files_status', {}) if self.data_cache else {}
        
        if df is None:
            st.error("‚ùå Dados n√£o dispon√≠veis")
            return
        
        # Verificar resultados de regras de associa√ß√£o
        analysis_files = files_status.get('analysis', [])
        association_files = [f for f in analysis_files 
                           if any(keyword in str(f).lower() 
                                 for keyword in ['apriori', 'fp_growth', 'eclat', 'association', 'rules'])]
        
        if association_files:
            st.success(f"‚úÖ {len(association_files)} arquivo(s) de regras encontrado(s)")
            
            for file in association_files:
                with st.expander(f"üìÅ {file.name}"):
                    try:
                        if file.suffix == '.csv':
                            df_rules = pd.read_csv(file)
                            st.dataframe(df_rules.head(10), use_container_width=True)
                            
                            # Estat√≠sticas das regras
                            if len(df_rules) > 0:
                                col1, col2, col3 = st.columns(3)
                                
                                with col1:
                                    st.metric("üìä Total de Regras", len(df_rules))
                                
                                with col2:
                                    if 'confidence' in df_rules.columns:
                                        avg_confidence = df_rules['confidence'].mean()
                                        st.metric("üéØ Confian√ßa M√©dia", f"{avg_confidence:.3f}")
                                
                                with col3:
                                    if 'lift' in df_rules.columns:
                                        avg_lift = df_rules['lift'].mean()
                                        st.metric("üìà Lift M√©dio", f"{avg_lift:.3f}")
                    except Exception as e:
                        st.error(f"Erro ao ler arquivo: {e}")
        else:
            st.warning("‚ö†Ô∏è Nenhum resultado de regras de associa√ß√£o encontrado")
            st.info("üí° Execute o pipeline principal para gerar regras: `python main.py`")
        
        # Prepara√ß√£o para regras de associa√ß√£o
        st.subheader("üìä An√°lise de Padr√µes nos Dados")
        
        categorical_cols = df.select_dtypes(include=['object']).columns.tolist()
        if categorical_cols:
            st.info(f"‚úÖ {len(categorical_cols)} vari√°veis categ√≥ricas dispon√≠veis")
            
            # An√°lise de frequ√™ncia
            selected_col = st.selectbox("Selecione uma vari√°vel para an√°lise:", categorical_cols)
            
            if selected_col:
                value_counts = df[selected_col].value_counts()
                fig = px.bar(
                    x=value_counts.index[:10],  # Top 10
                    y=value_counts.values[:10],
                    title=f"üìä Top 10 valores em {selected_col}"
                )
                st.plotly_chart(fig, use_container_width=True)
        
        # Informa√ß√µes sobre algoritmos
        st.subheader("üß† Algoritmos de Regras de Associa√ß√£o")
        
        col1, col2, col3 = st.columns(3)
        
        with col1:
            st.markdown("""
            **üìã APRIORI**
            - Algoritmo cl√°ssico
            - Baseado em suporte
            - Gera candidatos iterativamente
            """)
        
        with col2:
            st.markdown("""
            **üöÄ FP-GROWTH**
            - Mais eficiente que Apriori
            - Usa estrutura FP-Tree
            - Sem gera√ß√£o de candidatos
            """)
        
        with col3:
            st.markdown("""
            **‚ö° ECLAT**
            - Baseado em intersec√ß√£o
            - Eficiente para datasets esparsos
            - Abordagem vertical
            """)
    
    def _show_prediction_page(self):
        """P√°gina de predi√ß√£o - ESPEC√çFICA"""
        st.header("üîÆ Interface de Predi√ß√£o")
        
        df = self.data_cache.get('df') if self.data_cache else None
        files_status = self.data_cache.get('files_status', {}) if self.data_cache else {}
        
        if df is None:
            st.error("‚ùå Dados n√£o dispon√≠veis")
            return
        
        # Verificar modelos dispon√≠veis
        model_files = files_status.get('models', [])
        
        if not model_files:
            st.warning("‚ö†Ô∏è Nenhum modelo treinado encontrado")
            st.info("üí° Execute o pipeline principal para treinar modelos: `python main.py`")
            return
        
        st.success(f"‚úÖ {len(model_files)} modelo(s) dispon√≠vel(is)")
        
        # Interface de predi√ß√£o
        st.subheader("üìù Fazer Predi√ß√£o Individual")
        
        with st.form("prediction_form"):
            col1, col2 = st.columns(2)
            
            with col1:
                age = st.number_input("Idade", min_value=17, max_value=100, value=30)
                education_num = st.number_input("Anos de Educa√ß√£o", min_value=1, max_value=16, value=12)
                hours_per_week = st.number_input("Horas/Semana", min_value=1, max_value=99, value=40)
                capital_gain = st.number_input("Capital Gain", min_value=0, max_value=100000, value=0)
            
            with col2:
                workclass = st.selectbox("Classe de Trabalho", 
                                       ["Private", "Self-emp-not-inc", "Federal-gov", "Local-gov"])
                education = st.selectbox("Educa√ß√£o", 
                                       ["Bachelors", "HS-grad", "Masters", "Some-college"])
                marital_status = st.selectbox("Estado Civil",
                                            ["Married-civ-spouse", "Never-married", "Divorced"])
                sex = st.selectbox("Sexo", ["Male", "Female"])
            
            submitted = st.form_submit_button("üéØ Fazer Predi√ß√£o", use_container_width=True)
            
            if submitted:
                # Simular predi√ß√£o (implementar carregamento real do modelo)
                prediction_proba = np.random.random()
                
                if prediction_proba > 0.5:
                    st.success("üí∞ **Predi√ß√£o: Sal√°rio > 50K**")
                    st.info(f"Probabilidade: {prediction_proba:.3f}")
                else:
                    st.warning("üí∞ **Predi√ß√£o: Sal√°rio ‚â§ 50K**")
                    st.info(f"Probabilidade: {1-prediction_proba:.3f}")
                
                # Mostrar dados de entrada
                st.subheader("üìã Dados de Entrada")
                input_data = {
                    'Idade': age,
                    'Educa√ß√£o (anos)': education_num,
                    'Horas/Semana': hours_per_week,
                    'Capital Gain': capital_gain,
                    'Classe de Trabalho': workclass,
                    'Educa√ß√£o': education,
                    'Estado Civil': marital_status,
                    'Sexo': sex
                }
                
                input_df = pd.DataFrame([input_data])
                st.dataframe(input_df, use_container_width=True)
        
        # Exemplos de predi√ß√µes
        st.subheader("üìä Exemplos de Predi√ß√µes")
        
        if len(df) > 0:
            sample_data = df.sample(3)
            st.dataframe(sample_data, use_container_width=True)
    
    def _show_metrics_page(self):
        """P√°gina de m√©tricas - ESPEC√çFICA"""
        st.header("üìà M√©tricas e KPIs do Sistema")
        
        df = self.data_cache.get('df') if self.data_cache else None
        files_status = self.data_cache.get('files_status', {}) if self.data_cache else {}
        
        if df is None:
            st.error("‚ùå Dados n√£o dispon√≠veis")
            return
        
        # M√©tricas de qualidade dos dados
        st.subheader("üìä Qualidade dos Dados")
        
        col1, col2, col3, col4 = st.columns(4)
        
        with col1:
            completeness = (1 - df.isnull().sum().sum() / (len(df) * len(df.columns))) * 100
            st.metric("‚úÖ Completude", f"{completeness:.1f}%")
        
        with col2:
            uniqueness = df.nunique().sum() / len(df)
            st.metric("üîç Unicidade", f"{uniqueness:.1f}")
        
        with col3:
            consistency = 100  # Implementar c√°lculo real
            st.metric("üéØ Consist√™ncia", f"{consistency:.1f}%")
        
        with col4:
            validity = 95  # Implementar c√°lculo real
            st.metric("‚úì Validade", f"{validity:.1f}%")
        
        # M√©tricas do pipeline
        st.subheader("üîß Status do Pipeline")
        
        analysis_files = files_status.get('analysis', [])
        model_files = files_status.get('models', [])
        image_files = files_status.get('images', [])
        
        col1, col2, col3 = st.columns(3)
        
        with col1:
            st.metric("üìã An√°lises", len(analysis_files))
        
        with col2:
            st.metric("ü§ñ Modelos", len(model_files))
        
        with col3:
            st.metric("üñºÔ∏è Imagens", len(image_files))
        
        # Gr√°fico de distribui√ß√£o dos dados
        st.subheader("üìä Distribui√ß√£o das Vari√°veis")
        
        numeric_cols = df.select_dtypes(include=[np.number]).columns
        
        if len(numeric_cols) > 0:
            selected_var = st.selectbox("Selecione uma vari√°vel:", numeric_cols)
            
            fig = px.histogram(
                df, x=selected_var,
                title=f"üìä Distribui√ß√£o de {selected_var}"
            )
            st.plotly_chart(fig, use_container_width=True)
        
        # M√©tricas de performance (simuladas)
        st.subheader("‚ö° Performance do Sistema")
        
        col1, col2, col3 = st.columns(3)
        
        with col1:
            st.metric("‚è±Ô∏è Tempo de Carga", "1.2s")
        
        with col2:
            st.metric("üíæ Uso de Mem√≥ria", f"{df.memory_usage(deep=True).sum() / 1024 / 1024:.1f} MB")
        
        with col3:
            st.metric("üöÄ Uptime", "99.9%")
    
    def _show_reports_page(self):
        """P√°gina de relat√≥rios - ESPEC√çFICA"""
        st.header("üìÅ Relat√≥rios e Exporta√ß√µes")
        
        df = self.data_cache.get('df') if self.data_cache else None
        files_status = self.data_cache.get('files_status', {}) if self.data_cache else {}
        
        if df is None:
            st.error("‚ùå Dados n√£o dispon√≠veis")
            return
        
        # Relat√≥rio executivo
        st.subheader("üìã Relat√≥rio Executivo")
        
        col1, col2 = st.columns(2)
        
        with col1:
            st.markdown(f"""
            **üìä Resumo dos Dados:**
            - Total de registros: {len(df):,}
            - Colunas: {len(df.columns)}
            - Per√≠odo: {datetime.now().strftime('%Y-%m-%d')}
            """)
        
        with col2:
            if 'salary' in df.columns:
                high_salary_count = (df['salary'] == '>50K').sum()
                high_salary_rate = (df['salary'] == '>50K').mean()
                
                st.markdown(f"""
                **üí∞ An√°lise Salarial:**
                - Sal√°rios altos: {high_salary_count:,} ({high_salary_rate:.1%})
                - Sal√°rios baixos: {len(df) - high_salary_count:,} ({1-high_salary_rate:.1%})
                """)
        
        # Insights principais
        st.subheader("üí° Insights Principais")
        
        insights = []
        
        if 'age' in df.columns:
            avg_age = df['age'].mean()
            insights.append(f"üéÇ Idade m√©dia: {avg_age:.1f} anos")
        
        if 'education-num' in df.columns:
            avg_education = df['education-num'].mean()
            insights.append(f"üéì Educa√ß√£o m√©dia: {avg_education:.1f} anos")
        
        if 'hours-per-week' in df.columns:
            avg_hours = df['hours-per-week'].mean()
            insights.append(f"‚è∞ Horas m√©dias/semana: {avg_hours:.1f}h")
        
        for insight in insights:
            st.info(insight)
        
        # Se√ß√£o de exporta√ß√£o
        st.subheader("üì§ Exportar Dados")
        
        col1, col2, col3 = st.columns(3)
        
        with col1:
            if st.button("üìÑ Exportar CSV", use_container_width=True):
                csv = df.to_csv(index=False)
                st.download_button(
                    label="‚¨áÔ∏è Download CSV",
                    data=csv,
                    file_name=f"salary_data_{datetime.now().strftime('%Y%m%d')}.csv",
                    mime="text/csv"
                )
        
        with col2:
            if st.button("üìä Exportar Excel", use_container_width=True):
                # Implementar exporta√ß√£o Excel
                st.info("üöß Funcionalidade em desenvolvimento")
        
        with col3:
            if st.button("üìã Gerar PDF", use_container_width=True):
                # Implementar gera√ß√£o PDF
                st.info("üöß Funcionalidade em desenvolvimento")
        
        # Status dos arquivos gerados
        st.subheader("üìÅ Arquivos Gerados pelo Pipeline")
        
        all_files = []
        all_files.extend(files_status.get('analysis', []))
        all_files.extend(files_status.get('models', []))
        all_files.extend(files_status.get('images', []))
        
        if all_files:
            files_data = []
            for file in all_files:
                files_data.append({
                    'Nome': file.name,
                    'Tipo': file.suffix,
                    'Tamanho (KB)': f"{file.stat().st_size / 1024:.1f}",
                    'Modificado': datetime.fromtimestamp(file.stat().st_mtime).strftime('%Y-%m-%d %H:%M')
                })
            
            files_df = pd.DataFrame(files_data)
            st.dataframe(files_df, use_container_width=True)
        else:
            st.warning("‚ö†Ô∏è Nenhum arquivo gerado encontrado")
    
    def _show_admin_page(self):
        """P√°gina de administra√ß√£o - ESPEC√çFICA"""
        st.header("‚öôÔ∏è Administra√ß√£o do Sistema")
        
        user_data = self.auth.get_user_data()
        
        if user_data.get('role') != 'admin':
            st.error("‚ùå Acesso restrito a administradores!")
            return
        
        # Informa√ß√µes do sistema
        st.subheader("üíª Informa√ß√µes do Sistema")
        
        col1, col2, col3 = st.columns(3)
        
        with col1:
            st.metric("üë• Usu√°rios", "3")  # admin, user, demo
        
        with col2:
            st.metric("üîó Sess√µes Ativas", "1")
        
        with col3:
            st.metric("‚è±Ô∏è Uptime", "24h")
        
        # Gest√£o de usu√°rios
        st.subheader("üë• Gest√£o de Usu√°rios")
        
        users_data = [
            {'Usu√°rio': 'admin', 'Nome': 'Administrador', 'Papel': 'admin', 'Status': '‚úÖ Ativo'},
            {'Usu√°rio': 'user', 'Nome': 'Usu√°rio', 'Papel': 'user', 'Status': '‚úÖ Ativo'},
            {'Usu√°rio': 'demo', 'Nome': 'Demo', 'Papel': 'user', 'Status': '‚úÖ Ativo'}
        ]
        
        users_df = pd.DataFrame(users_data)
        st.dataframe(users_df, use_container_width=True)
        
        # Configura√ß√µes do sistema
        st.subheader("üîß Configura√ß√µes")
        
        col1, col2 = st.columns(2)
        
        with col1:
            if st.button("üßπ Limpar Cache", use_container_width=True):
                self.data_cache = None
                st.success("‚úÖ Cache limpo com sucesso!")
                st.rerun()
        
        with col2:
            if st.button("üîÑ Recarregar Sistema", use_container_width=True):
                st.success("‚úÖ Sistema recarregado!")
                st.rerun()
        
        # Logs do sistema
        st.subheader("üìã Logs do Sistema")
        
        logs_data = [
            {'Timestamp': datetime.now().strftime('%Y-%m-%d %H:%M:%S'), 'Evento': 'Login admin', 'Status': '‚úÖ'},
            {'Timestamp': (datetime.now()).strftime('%Y-%m-%d %H:%M:%S'), 'Evento': 'Dados carregados', 'Status': '‚úÖ'},
            {'Timestamp': (datetime.now()).strftime('%Y-%m-%d %H:%M:%S'), 'Evento': 'Dashboard iniciado', 'Status': '‚úÖ'}
        ]
        
        logs_df = pd.DataFrame(logs_data)
        st.dataframe(logs_df, use_container_width=True)

# Executar aplica√ß√£o
if __name__ == "__main__":
    dashboard = MultilingualDashboard()
    dashboard.run()